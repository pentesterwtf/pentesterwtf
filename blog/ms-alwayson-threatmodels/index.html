<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>M$ - AlwaysOn VPN first thoughts - Pentester, wtf!?</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="M$ - AlwaysOn VPN first thoughts"><meta property="og:description" content="AlwaysOn, initial thoughts and ideas"><meta property="og:type" content="article"><meta property="og:url" content="/blog/ms-alwayson-threatmodels/"><meta property="article:published_time" content="2019-07-26T19:15:00+10:00"><meta property="article:modified_time" content="2019-07-26T19:15:00+10:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="M$ - AlwaysOn VPN first thoughts"><meta name=twitter:description content="AlwaysOn, initial thoughts and ideas"><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css></head><body><div class="container wrapper post"><div class=header><a href=/><img src=/images/header.png alt="Break things, write reports"></a><div class=site-description></div><nav class=nav><ul class=flat><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li></ul></nav></div><div class=post-header><h1 class=title>M$ - AlwaysOn VPN first thoughts</h1><div class=meta>Posted at &mdash; Jul 26, 2019</div></div><div class=markdown><h2 id=tldr>tl;dr</h2><p>Microsofts' AlwaysOn VPN, thoughts on how it might work, lazy threat modelling</p><h2 id=what>What</h2><p>AlwaysOn, from <a href=https://docs.microsoft.com/en-us/windows-server/remote/remote-access/vpn/always-on-vpn/deploy/always-on-vpn-deploy>https://docs.microsoft.com/en-us/windows-server/remote/remote-access/vpn/always-on-vpn/deploy/always-on-vpn-deploy</a>:</p><blockquote><p>Always On VPN provides a single, cohesive solution for remote access and supports domain-joined, nondomain-joined (workgroup), or Azure AD–joined devices, even >personally owned devices. With Always On VPN, the connection type does not have to be exclusively user or device but can be a combination of both. For example, you >could enable device authentication for remote device management, and then enable user authentication for connectivity to internal company sites and services.</p></blockquote><ul><li>I don&rsquo;t care about the site-to-site features, I&rsquo;m more interested in the Win10 clients<ul><li>Especialy interested in the nondomain-joined hosts and how that works</li><li>This is the replacement to DirectAccess</li></ul></li><li>It can do split tunneling or forcibly route all traffic<ul><li>It can also do this on a per app (App-Based rules) or per CIDR (or DNS suffix) basis (Traffic-based rule)</li><li>Per app basis is interesting, especially if someone relies on it to be a routing control</li></ul></li></ul><h2 id=prereqs>Prereqs</h2><ul><li>Active Directory core services (i.e. Active Directory, DNS)<ul><li>End up just enabling AlwaysOn for a given group</li></ul></li><li>Active Directory Certificate Services<ul><li>User Cert template</li><li>VPN cert profile</li><li>NPS cert template</li></ul></li><li>A box running the Network Policy Server role (NPS)</li><li>RRAS, probably for the actual heavy lifting here</li></ul><h2 id=client>Client</h2><ul><li>PEAP-TLS with TPM–protected user certificates<ul><li>Windows Hello can be used here too (and/or Azure MFA + Azure conditional access)</li><li>Unsure of other options</li></ul></li><li>Config relies on a large XML blob</li></ul><h2 id=client-config>Client config</h2><ul><li>Sample ref points to a CSP <code>/Vendor/MSFT/VPNv2</code> <a href=https://docs.microsoft.com/en-us/windows-server/remote/remote-access/vpn/vpn-device-tunnel-config#configure-the-vpn-device-tunnel>https://docs.microsoft.com/en-us/windows-server/remote/remote-access/vpn/vpn-device-tunnel-config#configure-the-vpn-device-tunnel</a><ul><li>CSP - Configuration Service Provider - <a href=https://docs.microsoft.com/en-us/windows/configuration/provisioning-packages/how-it-pros-can-use-configuration-service-providers>https://docs.microsoft.com/en-us/windows/configuration/provisioning-packages/how-it-pros-can-use-configuration-service-providers</a></li><li>TODO - Further looks into CSP (it&rsquo;s just a big XML blob, and it appears to be the future for M$&rsquo;s idea of mobile device management)</li></ul></li><li>VPNv2 CSP is defined at <a href=https://docs.microsoft.com/en-us/windows/client-management/mdm/vpnv2-csp>https://docs.microsoft.com/en-us/windows/client-management/mdm/vpnv2-csp</a></li></ul><p>Simple breakdown:</p><pre><code>&lt;SyncML xmlns=&quot;SYNCML:SYNCML1.2&quot; xmlns:A=&quot;syncml:metinf&quot;&gt;
  &lt;SyncBody&gt;
    &lt;Atomic&gt;
      &lt;CmdID&gt;10000&lt;/CmdID&gt;

      &lt;!-- Configure VPN Server Name or Address (PhoneNumber=) [Comma Separated]--&gt;
      &lt;Add&gt;
        &lt;CmdID&gt;10001&lt;/CmdID&gt;
        &lt;Item&gt;
          &lt;Target&gt;
            &lt;LocURI&gt;./Vendor/MSFT/VPNv2/VPN_Demo/ProfileXML&lt;/LocURI&gt;
          &lt;/Target&gt;
          &lt;Data&gt;&lt;VPNProfile&gt;
  &lt;ProfileName&gt;VPN_Demo&lt;/ProfileName&gt;
  &lt;NativeProfile&gt;
    &lt;Servers&gt;VPNServer.contoso.com&lt;/Servers&gt;
    &lt;NativeProtocolType&gt;Automatic&lt;/NativeProtocolType&gt;
    &lt;Authentication&gt;
      &lt;UserMethod&gt;Eap&lt;/UserMethod&gt;
      &lt;Eap&gt;
        &lt;Configuration&gt;
&lt;EapHostConfig xmlns=&quot;http://www.microsoft.com/provisioning/EapHostConfig&quot;&gt; &lt;EapMethod&gt; &lt;Type xmlns=&quot;http://www.microsoft.com/provisioning/EapCommon&quot;&gt;25&lt;/Type&gt; &lt;VendorId xmlns=&quot;http://www.microsoft.com/provisioning/EapCommon&quot;&gt;0&lt;/VendorId&gt; &lt;VendorType xmlns=&quot;http://www.microsoft.com/provisioning/EapCommon&quot;&gt;0&lt;/VendorType&gt; &lt;AuthorId xmlns=&quot;http://www.microsoft.com/provisioning/EapCommon&quot;&gt;0&lt;/AuthorId&gt; &lt;/EapMethod&gt; &lt;Config xmlns=&quot;http://www.microsoft.com/provisioning/EapHostConfig&quot;&gt; &lt;Eap xmlns=&quot;http://www.microsoft.com/provisioning/BaseEapConnectionPropertiesV1&quot;&gt; &lt;Type&gt;25&lt;/Type&gt; &lt;EapType xmlns=&quot;http://www.microsoft.com/provisioning/MsPeapConnectionPropertiesV1&quot;&gt; &lt;ServerValidation&gt; &lt;DisableUserPromptForServerValidation&gt;false&lt;/DisableUserPromptForServerValidation&gt; &lt;ServerNames&gt;&lt;/ServerNames&gt; &lt;/ServerValidation&gt; &lt;FastReconnect&gt;true&lt;/FastReconnect&gt; &lt;InnerEapOptional&gt;false&lt;/InnerEapOptional&gt; &lt;Eap xmlns=&quot;http://www.microsoft.com/provisioning/BaseEapConnectionPropertiesV1&quot;&gt; &lt;Type&gt;13&lt;/Type&gt; &lt;EapType xmlns=&quot;http://www.microsoft.com/provisioning/EapTlsConnectionPropertiesV1&quot;&gt; &lt;CredentialsSource&gt; &lt;CertificateStore&gt; &lt;SimpleCertSelection&gt;false&lt;/SimpleCertSelection&gt; &lt;/CertificateStore&gt; &lt;/CredentialsSource&gt; &lt;ServerValidation&gt; &lt;DisableUserPromptForServerValidation&gt;false&lt;/DisableUserPromptForServerValidation&gt; &lt;ServerNames&gt;&lt;/ServerNames&gt; &lt;/ServerValidation&gt; &lt;DifferentUsername&gt;false&lt;/DifferentUsername&gt; &lt;PerformServerValidation xmlns=&quot;http://www.microsoft.com/provisioning/EapTlsConnectionPropertiesV2&quot;&gt;false&lt;/PerformServerValidation&gt; &lt;AcceptServerName xmlns=&quot;http://www.microsoft.com/provisioning/EapTlsConnectionPropertiesV2&quot;&gt;false&lt;/AcceptServerName&gt; &lt;TLSExtensions xmlns=&quot;http://www.microsoft.com/provisioning/EapTlsConnectionPropertiesV2&quot;&gt; &lt;FilteringInfo xmlns=&quot;http://www.microsoft.com/provisioning/EapTlsConnectionPropertiesV3&quot;&gt; &lt;EKUMapping&gt; &lt;EKUMap&gt; &lt;EKUName&gt;Unknown Key Usage&lt;/EKUName&gt; &lt;EKUOID&gt;1.3.6.1.4.1.311.87&lt;/EKUOID&gt; &lt;/EKUMap&gt; &lt;/EKUMapping&gt; &lt;ClientAuthEKUList Enabled=&quot;true&quot;&gt; &lt;EKUMapInList&gt; &lt;EKUName&gt;Unknown Key Usage&lt;/EKUName&gt; &lt;/EKUMapInList&gt; &lt;/ClientAuthEKUList&gt; &lt;/FilteringInfo&gt; &lt;/TLSExtensions&gt; &lt;/EapType&gt; &lt;/Eap&gt; &lt;EnableQuarantineChecks&gt;false&lt;/EnableQuarantineChecks&gt; &lt;RequireCryptoBinding&gt;false&lt;/RequireCryptoBinding&gt; &lt;PeapExtensions&gt; &lt;PerformServerValidation xmlns=&quot;http://www.microsoft.com/provisioning/MsPeapConnectionPropertiesV2&quot;&gt;false&lt;/PerformServerValidation&gt; &lt;AcceptServerName xmlns=&quot;http://www.microsoft.com/provisioning/MsPeapConnectionPropertiesV2&quot;&gt;false&lt;/AcceptServerName&gt; &lt;/PeapExtensions&gt; &lt;/EapType&gt; &lt;/Eap&gt; &lt;/Config&gt; &lt;/EapHostConfig&gt;
    &lt;/Configuration&gt;
      &lt;/Eap&gt;
    &lt;/Authentication&gt;
    &lt;RoutingPolicyType&gt;SplitTunnel&lt;/RoutingPolicyType&gt;
  &lt;/NativeProfile&gt;
  &lt;DomainNameInformationList&gt;
    &lt;DomainName&gt;.contoso.com&lt;/DomainName&gt;
    &lt;DNSServers&gt;10.5.5.5&lt;/DNSServers&gt;
  &lt;/DomainNameInformationList&gt;
 &lt;TrafficFilter&gt;  
    &lt;App&gt;%ProgramFiles%\Internet Explorer\iexplore.exe&lt;/App&gt; 
  &lt;/TrafficFilter&gt; 
  &lt;TrafficFilter&gt;  
    &lt;App&gt;Microsoft.MicrosoftEdge_8wekyb3d8bbwe&lt;/App&gt;  
  &lt;/TrafficFilter&gt;
  &lt;Route&gt;
    &lt;Address&gt;10.0.0.0&lt;/Address&gt;
    &lt;PrefixSize&gt;8&lt;/PrefixSize&gt;
  &lt;/Route&gt;
  &lt;Route&gt;
    &lt;Address&gt;25.0.0.0&lt;/Address&gt;
    &lt;PrefixSize&gt;8&lt;/PrefixSize&gt;
  &lt;/Route&gt;
    &lt;RememberCredentials&gt;true&lt;/RememberCredentials&gt;
  &lt;/VPNProfile&gt;&lt;/Data&gt;
        &lt;/Item&gt;
      &lt;/Add&gt;
    &lt;/Atomic&gt;
    &lt;Final/&gt;
  &lt;/SyncBody&gt;
&lt;/SyncML&gt;
</code></pre><ul><li>According to CSP, there can be multiple TrafficFilter tags<ul><li>They can include Apps, Claims, protocols and general port range stuff for limitations</li><li>Claims are reserved, no further info</li><li>Protocol is an int field, TCP is 6, UDP is 17</li><li>LocalAddressRange is a filter, curiously. Unsure of use</li><li>RemoteAddressRange is also a filter, more self explanatory</li></ul></li><li>Notice the <code>TrafficFilter</code> attribute takes an <code>&lt;app></code>, which can either be an app name or a file path<ul><li><code>PackageFamilyName</code> is the Microsoft store name</li><li>Notably theres' the option for <code>SYSTEM</code>, which will allow kernel drivers to send things through, the published example is for ICMP traffic</li><li>File path might be a bad design decision to rely on :)</li></ul></li><li><code>VPNv2/ProfileName/LockDown</code><ul><li>Apparently this will force there to only be one policy, and to not have networking without it enabled</li><li>How does this interact with captive portals?</li></ul></li><li><code>VPNv2/ProfileName/RegisterDNS</code><ul><li>Apparently used to ask the client to update AD/DNS</li><li>Good for device management purposes</li><li>Could this be used to help redirect traffic for other services? (i.e. rename host to <code>Sharepoint</code>, and now all traffic destined for <code>sharepoint.target.com</code> points here, responder to win?)<ul><li>Ignoring obvious permission issues and other things of existing objects</li></ul></li></ul></li><li><code>VPNv2/ProfileName/PluginProfile/CustomConfiguration</code><ul><li>&ldquo;Html encoded XML blob for SSL plug-in specific configuration including authentication information&rdquo;</li><li>Good place for persistence? Will always launch when user (automatically) connects to VPN</li></ul></li><li><code>VPNv2/ProfileName/EdpModeId</code><ul><li>Windows Information Protection policy blob goes here</li><li>See below</li></ul></li></ul><h2 id=windows-information-protection-wip>Windows Information Protection (WIP)</h2><p>Probably worth its own post, seems fairly big.</p><p>Seems to basically let people pretend they&rsquo;re still using Citrix without clipboard access. Offers the following:</p><ul><li>Core functionality: File encryption and file access blocking<ul><li>Encryption is probably leveraging the older DRM style offering, or is the next iteration <a href=https://docs.microsoft.com/en-us/azure/information-protection/develop/ad-rms-server>https://docs.microsoft.com/en-us/azure/information-protection/develop/ad-rms-server</a></li></ul></li><li>UX policy enforcement: Restricting copy/paste, drag/drop, and sharing operations</li><li>WIP network policy enforcement: Protecting intranet resources over the corporate network and VPN</li><li>Network policy enforcement: Protecting SMB and Internet cloud resources over the corporate network and VPN</li></ul><p>Sales pitch / no technical data at <a href=https://docs.microsoft.com/en-au/windows/security/information-protection/windows-information-protection/protect-enterprise-data-using-wip>https://docs.microsoft.com/en-au/windows/security/information-protection/windows-information-protection/protect-enterprise-data-using-wip</a></p><h2 id=deployment>Deployment</h2><ul><li>SCCM / Intune<ul><li>Not really much published here, SCCM probably has a silly prereq of a particular version</li></ul></li></ul><h2 id=misc>Misc</h2><ul><li>Apparently you can&rsquo;t revoke machine certificates yet <a href=https://docs.microsoft.com/en-us/windows-server/remote/remote-access/vpn/always-on-vpn/deploy/always-on-vpn-adv-options#blocking-vpn-clients-that-use-revoked-certificates>https://docs.microsoft.com/en-us/windows-server/remote/remote-access/vpn/always-on-vpn/deploy/always-on-vpn-adv-options#blocking-vpn-clients-that-use-revoked-certificates</a><ul><li>Typical shitty MS stuff, yo</li></ul></li><li>If your internal network sucked, making it suck over the internet is going to make it suck more when someone steals a laptop<ul><li>Per app routing (TrafficFilter/App) - Does this propogate to child PIDS or just the parent process?</li></ul></li><li>Apparently theres a <code>HealthAttestation</code> CSP, which can tie in with this</li></ul></div></div><div class="footer wrapper"><nav class=nav><div></div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-141761824-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>