<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>XSS in the trusted zone is drive-by RCE - Pentester, wtf!?</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="XSS in the trusted zone is drive-by RCE"><meta property="og:description" content="Seemingly everyone has forgotten how internet explorer works"><meta property="og:type" content="article"><meta property="og:url" content="/blog/ie-trusted-zone/"><meta property="article:published_time" content="2020-10-24T11:00:00+10:00"><meta property="article:modified_time" content="2020-10-24T11:00:00+10:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="XSS in the trusted zone is drive-by RCE"><meta name=twitter:description content="Seemingly everyone has forgotten how internet explorer works"><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css></head><body><div class="container wrapper post"><div class=header><a href=/><img src=/images/header.png alt="Break things, write reports"></a><div class=site-description></div><nav class=nav><ul class=flat><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li></ul></nav></div><div class=post-header><h1 class=title>XSS in the trusted zone is drive-by RCE</h1><div class=meta>Posted at &mdash; Oct 24, 2020</div></div><div class=markdown><h2 id=tldr>Tl;dr</h2><pre><code>&lt;script&gt;
      var ws = new ActiveXObject(&quot;WScript.Shell&quot;);
      ws.Exec(&quot;c:\\windows\\system32\\calc.exe&quot;);
&lt;/script&gt;
</code></pre><p>Find some webapp in the trusted zone, get XSS in it, pop calc on all visitors using IE.</p><h2 id=trusted-zone>Trusted Zone</h2><p>For those who have worked in corporate, you&rsquo;ve probably needed to use Internet Explorer for <em>something</em> that&rsquo;s both critical to not getting yelled at by your boss, and also critical that you use so you get paid. Normally, these are things like Payroll, Timesheets, or Mandatory training nonsense, which meets the above two criteria nicely. If you work in Security, and in more of the offensive side, you probably probably don&rsquo;t like using IE for a few reasons:</p><ul><li>Changing tabs seems to suck on every enterprise Standard Operating Environment (SOE) for seemingly unknown reasons</li><li>If you&rsquo;re not using the corporate SOE, you probably have defaults in IE, and it&rsquo;s asking you to set it to your default browser</li><li>Probably doesn&rsquo;t have your password extension of choice installed</li><li>You&rsquo;re aware of ActiveX and the Trusted zone</li></ul><p>I suspect everyone&rsquo;s aware of the first 3 points, but the third point seems to be a little less-known, even though it&rsquo;s been previously reported by places like:</p><ul><li>Invisibiledenizen on SecLists, 2008, <a href=https://seclists.org/metasploit/2008/q4/315>https://seclists.org/metasploit/2008/q4/315</a></li><li>InvisibleDenizen&rsquo;s blog, 2009 (one month later), <a href=http://blog.invisibledenizen.org/2009/01/ieunsafescripting-metasploit-module.html>http://blog.invisibledenizen.org/2009/01/ieunsafescripting-metasploit-module.html</a></li><li>NCC Group, 2016, <a href=https://www.nccgroup.com/au/about-us/newsroom-and-events/blogs/2016/june/when-a-trusted-site-in-internet-explorer-was-anything-but/>https://www.nccgroup.com/au/about-us/newsroom-and-events/blogs/2016/june/when-a-trusted-site-in-internet-explorer-was-anything-but/</a></li></ul><p>This is to exclude things like pro-hackers.com (<a href=https://pro-hackers.com/get-access-when-people-visit-website/),>https://pro-hackers.com/get-access-when-people-visit-website/),</a> which appears to be some auto generated garbage using the metasploit module built in 2008 but not explaining how or why it&rsquo;s important. Continuing to shit on someone elses &ldquo;content&rdquo;, it was &ldquo;written&rdquo; in 2019 but describes using &ldquo;BackTrack 5&rdquo;, which was replaced by Kali in 2013, and says &ldquo;root&rdquo; access even though we know the targets are Windows boxes.</p><p>Anyway.</p><p>Intenet Explorer has a few different &ldquo;zones&rdquo;, which other browsers don&rsquo;t really have a concept of. IE breaks it down into:</p><ul><li>Internet</li><li>Local Intranet</li><li>Trusted Sites</li><li>Restricted Sites</li></ul><p>These basically end up being a list of different origins and have different rules applied, things like allowing kerberos auth or relaxing the same origin policy.</p><p>For an actual breakdown, I&rsquo;d recommend reading the source materials (<a href=https://support.microsoft.com/en-us/help/182569/internet-explorer-security-zones-registry-entries-for-advanced-users>https://support.microsoft.com/en-us/help/182569/internet-explorer-security-zones-registry-entries-for-advanced-users</a>)</p><p>The big scary one is <code>1201 ActiveX controls and plug-ins: Initialize and script ActiveX controls not marked as safe for scripting</code>, which is normally enabled for the Trusted Zone, and allows the browser to automatically execute ActiveX controls without user input or a prompt.</p><p>Consider the following script:</p><pre><code>&lt;script&gt;
      var ws = new ActiveXObject(&quot;WScript.Shell&quot;);
      ws.Exec(&quot;c:\\windows\\system32\\calc.exe&quot;);
&lt;/script&gt;

</code></pre><p>If you are able to get this into a site within the trusted zone, either through reflected or worse, stored cross site scripting, visitors using IE to browse the site (i.e. users on the corporate network, using the corporate SOE, with said configuration), are going to have a big fat calculator pop up when they browse the site.</p><p>Obviously, this isn&rsquo;t ideal as a defender, but is pretty top tier as an attacker!</p><h2 id=whats-in-the-trusted-zone>What&rsquo;s in the trusted zone?</h2><p>Good question. If your target uses Dynamix CRM, it&rsquo;s likely quite a few websites (KB 2655102, <a href=https://support.microsoft.com/en-us/help/2655102/internet-accessible-urls-required-for-connectivity-to-microsoft-dynami)>https://support.microsoft.com/en-us/help/2655102/internet-accessible-urls-required-for-connectivity-to-microsoft-dynami)</a>. Notably, this includes things like:</p><ul><li>*.windows.net</li><li>*.azureedge.net</li></ul><p>Notably, these are websites that you can just host content on as a regular user, *.windows.net is just azure blob storage (<a href=https://azure.microsoft.com/en-au/services/storage/blobs/),>https://azure.microsoft.com/en-au/services/storage/blobs/),</a> so anyone can sign up and host content, which will give you a lovely foothold in an environment.</p><p>There&rsquo;s also some indications these might just be needed for O365 bits in general (<a href=https://techcommunity.microsoft.com/t5/deployment/trusted-sites-and-local-intranet-assigment-for-office-365/m-p/127034),>https://techcommunity.microsoft.com/t5/deployment/trusted-sites-and-local-intranet-assigment-for-office-365/m-p/127034),</a> which doesn&rsquo;t seem to list windows.net, but a lot of unofficial guides seem to include weird domains. These are probably the guides your target are following, as sysadmin documentation seems to be easier to find on Reddit than on MSDN.</p><p>Unsure about some of the other domains in there like *.crm9 (Is that also user hosted content? Probably a good TODO, for anyone with a Dynamics CRM).</p><h2 id=addendum---crappy-phishing>Addendum - Crappy phishing</h2><p>Most of the lame phishing seems to be aware of windows.net, but not that it&rsquo;s probably RCE in most cases for organisations using Dynamics CRM. This hasn&rsquo;t been unnoticed (<a href=https://www.bleepingcomputer.com/news/security/phishing-attack-uses-azure-blob-storage-to-impersonate-microsoft/),>https://www.bleepingcomputer.com/news/security/phishing-attack-uses-azure-blob-storage-to-impersonate-microsoft/),</a> but no one&rsquo;s seemed to put two and two together that they could just be getting RCE on an endpoint and getting a lovely foothold in an environment, instead of just crappy credential phishing.</p><p>A lot of these seem to be added to the trusted zone for things like Kerberos auth (<a href=https://blog.peterdahl.net/2017/09/12/login-windows-net-still-needs-to-be-added-to-trusted-sites-in-internet-explorer/),>https://blog.peterdahl.net/2017/09/12/login-windows-net-still-needs-to-be-added-to-trusted-sites-in-internet-explorer/),</a> so a lot of orgs are going to just have this set without much further insight.</p><h2 id=addendum---legacy-applications>Addendum - Legacy applications</h2><p>Normally, having to use IE is horrid by itself - The trusted zone is going to have Legacy Applications(TM), which roughly translates to &ldquo;Things we need but don&rsquo;t want to upgrade because it&rsquo;s expensive&rdquo;. Legacy is also anotehr word for &lsquo;probably insecure&rsquo;, and is commonly riddled with things like cross site scripting - which if it&rsquo;s in the trusted zone, you now get drive-by RCE on endpoints that browse it with Internet Explorer.</p><p>The best bit? If it&rsquo;s in the trusted zone, it&rsquo;s probably <em>because</em> the webapp needed some silly feature, so people who browse it are likely to be running IE when using it - you&rsquo;re going to end up with RCE :)</p><p>Alternatively, there&rsquo;s the <code>local intranet zone</code>, which is almost the same except you&rsquo;ll get an awful prompt asking if you want to run ActiveX objects, and lots of things get put here automatically. User interaction is a kind of lame thing to rely on, but they&rsquo;re probably going to click yes anyway, and if you get stored XSS on some app everyone uses, it&rsquo;s just going to be a numbers game anyway.</p><p>Enjoy!</p></div></div><div class="footer wrapper"><nav class=nav><div></div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-141761824-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>