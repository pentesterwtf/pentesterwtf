<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>AD - Account Lockout vs Disabled - Pentester, wtf!?</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="AD - Account Lockout vs Disabled"><meta property="og:description" content="Disabling an account in AD isn't instant, but a lockout is."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2019/lockout-vs-disabled/"><meta property="article:published_time" content="2019-10-17T20:30:00+10:00"><meta property="article:modified_time" content="2019-10-17T20:30:00+10:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AD - Account Lockout vs Disabled"><meta name=twitter:description content="Disabling an account in AD isn't instant, but a lockout is."><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css></head><body><div class="container wrapper post"><div class=header><a href=/><img src=/images/header.png alt="Break things, write reports"></a><div class=site-description></div><nav class=nav><ul class=flat><li><a href=/>home</a></li><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li></ul></nav></div><div class=post-header><h1 class=title>AD - Account Lockout vs Disabled</h1><h3><blockquote>Disabling an account in AD isn't instant, but a lockout is.</blockquote></h3><div class=meta>Tags &mdash; |
<a href=/tags/windows/>windows</a> |
<a href=/tags/active-directory/>active-directory</a> |
Categories: &mdash;
<a href=/categories/windows/>windows</a> |</div><div class=meta>Posted at &mdash; Oct 17, 2019</div></div><div class=markdown><p>tl;dr - Disabling an account in AD will replicate normally, which can give an attacker quite a bit of time :)</p><h2 id=what>What</h2><h3 id=account-lockout-vs-disabled-account>Account lockout vs Disabled account</h3><ul><li>Disabling an account sets a flag in the <code>userAccountControl</code></li><li>This attribute is handled via normal replication</li><li>Locking an account out is when an accounts <code>BadLogonCount</code> exceeds some threshold ( <a href=https://docs.microsoft.com/en-us/windows/win32/adschema/a-lockoutthreshold>Lockout-Threshold</a> )<ul><li>This sets the <code>lockoutTime</code> and <code>Lockout-Duration</code> attributes on an account, and then is handled by immediate replication instead of &ldquo;normal&rdquo; replication</li><li>Edge case - this also gets compared against <code>LastBadPasswordAttempt</code></li><li>Also useful to note, this attribute isn&rsquo;t replicated :)</li></ul></li></ul><h3 id=normal-replication-how-fast-is-that>&lsquo;Normal&rsquo; replication, how fast is that?</h3><ul><li><p>Intra-site</p><ul><li>i.e. Head office is full of domain controllers, replication between these</li><li>15 seconds, with a 3 second pause for the next replication partner (i.e. Other DC&rsquo;s)</li><li>Handled by the <code>msDS-Replication-Notify-First-DSA-Delay</code> and <code>msDS-Replication-Notify-Subsequent-DSA-Delay</code> attributes configured on a site</li></ul></li><li><p>Inter-site</p><ul><li>i.e. Someone did AD properly, and put geographically disparate domain controllers in different AD sites</li><li>This is less common in AU than you&rsquo;d think, FYI</li><li><a href=https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/determining-the-interval>180 minute replication</a></li></ul></li><li><p>Exception - &ldquo;Urgent Replication&rdquo;</p><ul><li>This is immediate</li><li>Will always replicate to all domain controllers on the same site, at the same time (ignores the <code>msDS-Replication-Notify-First-DSA-Delay</code> and <code>msDS-Replication-Notify-Subsequent-DSA-Delay</code> attribute)</li></ul></li></ul><p>Curiously, an account unlock is not immediate - so you can be waiting 180 minutes for an account lock to come into effect in a remote office.</p><p>You can change inter-site to replicate immediately with &lsquo;Inter-Site change notification&rsquo;, but I haven&rsquo;t seen it deployed in any of the places I&rsquo;ve checked - but perhaps it&rsquo;s common elsewhere?</p><h3 id=why-does-this-matter>Why does this matter</h3><p>If an insider threat materialises (read: an attacker you had on payroll), disabling their account isn&rsquo;t going to do much, almost to the point of they could drive to another remote office and still log in to steal a bunch of stuff.</p><p>This is completely ignoring that kerberos tickets for an account are going to last for hours, so if an attacker steals kerberos tickets, you&rsquo;re going to be in grief for a few hours.</p><p>Also worth mentioning that if their machine is still logged in, and they didn&rsquo;t lock their windows box - they&rsquo;ve still got a machine they can use until other systems stop accepting kerberos credentials (i.e. sharepoint, where you&rsquo;re keeping all the goodies)</p><p>Keeping that in mind, if you want to offboard your employees:</p><ul><li>Lock their account<ul><li>Using the wrong password on an auth attempt a couple of times is going to work well here, don&rsquo;t bother doing it via ADSIedit</li></ul></li><li>Take their machine off them</li><li>Figure out where they&rsquo;re logged in, and kill their sessions</li><li>No idea on Kerberos, does a password reset invalidate existing TGT&rsquo;s as they&rsquo;re encrypted with the users password anyway?</li></ul></div></div><div class="footer wrapper"><nav class=nav><div></div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-141761824-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>