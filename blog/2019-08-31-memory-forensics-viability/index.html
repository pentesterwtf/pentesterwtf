<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>On the viability of memory forensics in compromised environments - Pentester, wtf!?</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="On the viability of memory forensics in compromised environments"><meta property="og:description" content="When a machine is owned, can you really trust it to give you reliable data for incident response?"><meta property="og:type" content="article"><meta property="og:url" content="/blog/2019-08-31-memory-forensics-viability/"><meta property="article:published_time" content="2019-08-31T14:00:00+10:00"><meta property="article:modified_time" content="2019-08-31T14:00:00+10:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="On the viability of memory forensics in compromised environments"><meta name=twitter:description content="When a machine is owned, can you really trust it to give you reliable data for incident response?"><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css></head><body><div class="container wrapper post"><div class=header><a href=/><img src=/images/header.png alt="Break things, write reports"></a><div class=site-description></div><nav class=nav><ul class=flat><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li></ul></nav></div><div class=post-header><h1 class=title>On the viability of memory forensics in compromised environments</h1><div class=meta>Posted at &mdash; Aug 31, 2019</div></div><div class=markdown><h2 id=viability-of-memory-forensics>Viability of Memory Forensics</h2><p>A pretty cool paper was written up in 2015 regarding the viability of memory forensics in compromised environments - aptly titled: <code>On the Viability of Memory Forensics in Compromised Environments</code>. You can find the paper at <a href=https://pdfs.semanticscholar.org/6d26/be83b674231a301e7bed762895f14e613f66.pdf>https://pdfs.semanticscholar.org/6d26/be83b674231a301e7bed762895f14e613f66.pdf</a></p><p>Fundamentally, this comes down to <code>can you trust an owned box</code> - I put forward that you probably can under <em>some</em> circumstances, and not at all when an attacker is competent. Luckily for me, this paper gives me some (formal) backing, rather than intuiting that an attacker controlled machine is no longer your machine, and the integrity of code on the machine is no longer certain.</p><p>Or less formally, it&rsquo;s not your machine when someone else owns it - it&rsquo;s running whatever they want, and your splunk agent probably isn&rsquo;t reporting back what you&rsquo;d want it to.</p><h2 id=the-paper>The paper</h2><p>There&rsquo;s probably some fashion in how someone cites academia, I&rsquo;ve got no clue, but it looks like it&rsquo;s written as a thesis paper by <code>Johannes Stuettgen</code> - That&rsquo;ll have to do. If it appeals to anyones authority - he thanks the Google Incident Response Team for their working environment, so the guns over there probably provided some insight at the least.</p><p>The abstract describes:</p><ul><li>We tested 12 memory forensics tools</li><li>All of them were vulnerable to <code>anti-forensics</code> (i.e. Malware hooking API calls)</li><li>This happens because you&rsquo;re trusting the operating system to provide functions to read memory</li><li>We avoid this entirely by interacting with hardware via PCI</li></ul><p>Quoting Chapter 5, section 1:</p><blockquote><p>To become more resilient against anti-forensic attacks, memory acquisition software
must stop relying on the potentially subverted OS to perform its task.</p></blockquote><p>Johannes nails it here - you&rsquo;re trusting a box running unknown code to tell you it&rsquo;s running unknown code, but comes up with this idea around mapping memory without asking the OS to do it.</p><p>I didn&rsquo;t consider the approach in Chapter 5 previously - it comes down to the difference of asking the kernel to map memory for you and mapping the memory yourself via interacting with PCI. Apparently this is harder to hook, and isn&rsquo;t a thing people are looking for, so it&rsquo;s probably hard for an attacker to figure out it&rsquo;s happening.</p><p>This technique has been put in winpmem since 2014, thanks to the author.</p><p>The author does note however, that this relies on loading a driver - perhaps this is a thing an attacker should be aware of.</p><p>I don&rsquo;t know what the solution is - hardware based acquisition (cited but not explored here), is hard to roll out. I&rsquo;ve managed to hot-plug PCIe devices into my desktop, but I don&rsquo;t know if that works everywhere, or if its even a good idea; so you&rsquo;re still up a proverbial creek when it comes to doing this at scale. I did learn that if you communicate straight to the PCI bus, you&rsquo;re gonna have a better time than trusting the OS, but I&rsquo;m still unsure of how much you can trust the <em>machine</em>.</p><p>Again, go check out the paper - <a href=https://pdfs.semanticscholar.org/6d26/be83b674231a301e7bed762895f14e613f66.pdf>https://pdfs.semanticscholar.org/6d26/be83b674231a301e7bed762895f14e613f66.pdf</a></p></div></div><div class="footer wrapper"><nav class=nav><div></div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-141761824-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>